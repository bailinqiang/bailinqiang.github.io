<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="java, 程序员, 并发, 并行">










<meta name="description" content="a simple man records a little simple things">
<meta property="og:type" content="website">
<meta property="og:title" content="A simple man">
<meta property="og:url" content="https://bailinqiang.github.io/index.html">
<meta property="og:site_name" content="A simple man">
<meta property="og:description" content="a simple man records a little simple things">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="A simple man">
<meta name="twitter:description" content="a simple man records a little simple things">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://bailinqiang.github.io/">





  <title>A simple man</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">A simple man</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://bailinqiang.github.io/2019/12/24/内存计算/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="白林强">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="A simple man">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/24/内存计算/" itemprop="url">内存计算</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-24T16:28:52+08:00">
                2019-12-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="褚霸大神的图"><a href="#褚霸大神的图" class="headerlink" title="褚霸大神的图"></a><a href="http://blog.yufeng.info/archives/2456/free-3?spm=ata.13261165.0.0.13586dd6mT1x9q" target="_blank" rel="noopener">褚霸大神的图</a></h4><p>内存的去向主要有3个：1、<strong>进程消耗</strong>。 2、<strong>slab消耗</strong> 3、<strong>pagetable消耗</strong>。</p>
<h4 id="进程消耗"><a href="#进程消耗" class="headerlink" title="进程消耗"></a>进程消耗</h4><p>通过top命令看到的res就是用户进程的消耗<br><img src="/2019/12/24/内存计算/res.png" title="res截图"></p>
<h4 id="slab消耗"><a href="#slab消耗" class="headerlink" title="slab消耗"></a>slab消耗</h4><p>简单的说内核为了高性能每个需要重复使用的对象都会有个池，这个slab池会cache大量常用的对象，所以会消耗大量的内存。通过 slabtop来查看具体使用情况。</p>
<h4 id="pagetable消耗"><a href="#pagetable消耗" class="headerlink" title="pagetable消耗"></a>pagetable消耗</h4><p>管理这些物理页面的硬开销</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://bailinqiang.github.io/2019/08/13/本地缓存的坑/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="白林强">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="A simple man">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/13/本地缓存的坑/" itemprop="url">本地缓存的坑</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-13T16:31:12+08:00">
                2019-08-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在开发过程中我们qps比较高的场景，难免会使用到缓存，以便减少db的压力。缓存使用比较多的话有redis等缓存。可以作为分布式缓存。<br>但是redis等缓存， 还是会走网络传输(只不过缓存服务器有优化，比如是基于内存的)，大概也需要1ms左右，那么有些场景加速或者减少缓存服务器压力<br>会使用本地缓存，例如自己实现的map、google 的guava等。这些会在机器本地进行缓存，加速数据的获取、减少缓存服务器的压力。<br>我们项目的数据获取架构是 localCacheLoader –&gt; RedisCacheLoader  –&gt; dbLoader。 localCache用的是com.google.common.cache.Cache类。<br>在项目中发现一个问题，localCacheLoader 代码如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Object&gt; result = localCacheLoader.get(cacheKey, () -&gt; &#123;</span><br><span class="line">                    List&lt;Object&gt; list = origin.load();</span><br><span class="line">                    return list == null? Collections.emptyList():list;</span><br><span class="line">                &#125;);</span><br></pre></td></tr></table></figure></p>
<p>然后发现一个问题 result 和  origin.load()获取的值不一致！。问题的表现就是，本地缓存create的值和load出来的值不同。<br>因为之前用redis或者db加载数据，并发下，返回的都是值(也就是说不是同一个引用)。我以为google的本地缓存设计和redis一样，但是没有考虑到它返回的确实是<br>引用。result可以在其他地方被修改，修改的也是引用，也就是localCache中的值被修改了。下一个线程取值的时候就会取到不正确的(不是create时的值，没有显式的put)。</p>
<p>总结： 在使用本地缓存load数据的时候，要修改值需要谨慎，或者显式的更新本地缓存。不然会存在上诉提到的问题。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://bailinqiang.github.io/2019/05/13/链表/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="白林强">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="A simple man">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/13/链表/" itemprop="url">链表</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-13T11:05:31+08:00">
                2019-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/面试题-链表/" itemprop="url" rel="index">
                    <span itemprop="name">面试题 链表</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>java中的列表常见的：LinkedList 是一个双向链表，结构如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinkedList</span></span>&#123;</span><br><span class="line">    Node&lt;E&gt; first;</span><br><span class="line">    Node&lt;E&gt; last;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">        E item;</span><br><span class="line">        Node&lt;E&gt; next;</span><br><span class="line">        Node&lt;E&gt; prev;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>就这么简单的结构，单双体现在Node节点上，双向的Node可以向前和向后，也就是有 next和prev操作，对于列表来说，只需要告诉头尾即可。<br>面试题：怎么判断两个单向链表有没有相交、是否有交点、是否成环：</p>
<ul>
<li><a href="https://blog.csdn.net/fengxinlinux/article/details/78885764" target="_blank" rel="noopener">转载答案</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://bailinqiang.github.io/2019/04/05/java编译器优化指令执行顺序/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="白林强">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="A simple man">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/05/java编译器优化指令执行顺序/" itemprop="url">java编译器优化指令执行顺序</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-05T21:44:11+08:00">
                2019-04-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>随着现在jvm的改进，为了加速在指令上都有一些优化，话不多说 直接看例子<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">boolean</span> status = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> number = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">new</span> Thread()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                number = <span class="number">100</span>;</span><br><span class="line">                status = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (status) &#123;</span><br><span class="line">                System.out.println(<span class="string">"status is true number is "</span>+ number);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">"number is "</span> + number);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>这段代码，我们咋一看 由于线程start时机不受我们程序控制。那么可能限制性 第一个线程，可能先执行第二个线程，或者两个一起执行。<br>先不管这个，反正根据竞态条件，第一感觉有两种print:<br>1、status is true number is 100;<br>2、number is false;<br>3、numbr is 100;<br>那么问题来了，实际执行过程中会存在第四种情况 4、status is true  number is false;<br>这是为什么呢，其实是jvm判断第一个线程执行的时候，根据语义 指令number = 100 和指令status = true  不存在before and happend关系，就可以进行指令的重排序，<br>那么 就会出现 可能线程1 先执行status = true,在执行number = 100,但是在这两个指令过程中间，线程2执行了，所以会出现第四中情况。<br>结果请看代码 (第四种属于比较不常见现象，所以多试几次才会出现，当然代码写的low一些，不过道理是这么个道理)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2000</span>; i++) &#123;</span><br><span class="line">        <span class="comment">// 每次 main函数初始化，，当然最好的做法是用原子 操作。final</span></span><br><span class="line">        status = <span class="keyword">false</span>;</span><br><span class="line">        number = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">new</span> Thread()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                number = <span class="number">100</span>;</span><br><span class="line">                status = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (status) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"status is true number is "</span>+ number);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">"number is "</span> + number);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line">        <span class="comment">// 休息2ms  保证下次循环不会修改本次的结果</span></span><br><span class="line">        Thread.sleep(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>结果我就贴图吧<img src="/images/race.jpg" width="500" height="150" title="图片"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://bailinqiang.github.io/2019/03/21/linux-内存/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="白林强">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="A simple man">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/21/linux-内存/" itemprop="url">linux-内存</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-21T10:46:52+08:00">
                2019-03-21
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/memory分析/" itemprop="url" rel="index">
                    <span itemprop="name">memory分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://bailinqiang.github.io/2019/03/20/茶馆/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="白林强">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="A simple man">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/20/茶馆/" itemprop="url">茶馆读后感</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-20T15:09:22+08:00">
                2019-03-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/小说读后感/" itemprop="url" rel="index">
                    <span itemprop="name">小说读后感</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/小说读后感/茶馆/" itemprop="url" rel="index">
                    <span itemprop="name">茶馆</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>首先致敬老舍先生，能写出这么好的小说，<a href="https://book.douban.com/subject/4275058/" target="_blank" rel="noopener">豆瓣评分9.1</a><br>书中对每个人物的描写都很生动形象，看后令人记忆深刻。我来说下我总的感受。<br>首先说下不是很起眼的一个小人物 三爷,一个打工的，比王掌柜的年纪还大，老掌柜在世时就是伙计，在第二幕的时候，三爷说了句话：“二十年了，谁给我涨过工资，这前前后后就我一个人，迟早给我累死” 大概是这么句话，我们现在看来，二十年不涨工资，几乎不敢想象是吧，在大城市，一年不涨都不行，GDP每年都在彪、房价更是一年一个价格，每年不涨工资其实就是变相在降薪。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://bailinqiang.github.io/2019/03/19/load/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="白林强">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="A simple man">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/19/load/" itemprop="url">关于系统的负载</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-19T11:12:40+08:00">
                2019-03-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/load分析/" itemprop="url" rel="index">
                    <span itemprop="name">load分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="经常听说系统挂了，电脑卡了，那么具体的指标体现在什么地方呢"><a href="#经常听说系统挂了，电脑卡了，那么具体的指标体现在什么地方呢" class="headerlink" title="经常听说系统挂了，电脑卡了，那么具体的指标体现在什么地方呢"></a>经常听说系统挂了，电脑卡了，那么具体的指标体现在什么地方呢</h3><p>常见的电脑卡 ： 内存满了开始与磁盘进行内存交换、cpu 使用率满了、磁盘io满了等这些硬件指标达到一定数量<br>今天我们来说一说系统的负载。<br>查询内存、cpu、io等 有很多命令可以看 其中最简单、直白的莫过于top了<br>我们所说的系统负载很高是什么意思呢，我们来看下什么是负载、怎么查看、多少负载合适</p>
<ul>
<li><p>首先负载的意思，对于一个系统 负载是 总的进程数量  /   单位时间内系统可以处理的进程数量<br>举个例子，经典的例子：车要过桥，假设只有一条桥(对应单核系统) ,单位时间内可以通行10辆车，那么 当没有车通行时  0 / 10 = 0,load为0<br>当有5辆车通行时，5/10 = 0.5,当有10辆时 ，这时候系统的负载为1 也就是100%了(单核系统)。那么当再来多的车，需要排队等待了，所以这时候系统可能就会有点卡(如果都是计算的进行，那么cpu会很满，如果是io进程，对于cpu来说压力就小很多)。如果来100辆车，那么可想而知，桥外面就得等待90辆，负载达到10 已经很高了，需要排查问题。<br>上面的例子都是单核的，那么对于多核系统，负载只反映在单核上，怎么理解呢，比如100辆车，假如 有10座桥，那么是不是没有等待的？负载按道理说应该是1呢，其实不然 这个负载还是10。(我也不知道为什么，反正就是这么定义的)。这个时候的load:10 和单核时候的load:10差距就很大了，所以观察load数字需要结合具体的核数（linux 系统查看核数: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/cpuinfo | grep &apos;cpu cores&apos;</span><br><span class="line">cpu cores : 4</span><br><span class="line">-- 或者</span><br><span class="line">top  (然后按  1 )</span><br><span class="line">%Cpu0  :  0.0 us,  0.3 sy,  0.0 ni, 91.4 id,  0.0 wa,  0.0 hi,  0.0 si,  8.3 st</span><br><span class="line">%Cpu1  :  0.3 us,  0.3 sy,  0.0 ni, 97.0 id,  0.0 wa,  0.0 hi,  0.0 si,  2.3 st</span><br><span class="line">%Cpu2  :  0.0 us,  0.3 sy,  0.3 ni, 96.3 id,  0.0 wa,  0.0 hi,  0.0 si,  3.0 st</span><br><span class="line">%Cpu3  :  0.0 us,  0.0 sy,  0.0 ni, 93.6 id,  0.0 wa,  0.0 hi,  0.0 si,  6.4 st</span><br></pre></td></tr></table></figure>
</li>
<li><p>如何查看系统负载<br>介绍几个命令<br>1、top<br>2、w<br>3、uptime<br>4、cat /proc/loadavg<br>等  这些只要一个就够了 load会print三个指数 我电脑:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">w</span><br><span class="line">11:11  up 4 days, 19:05, 2 users, load averages: 1.93 2.16 2.37</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>load averages 依次表示的是 1分钟  5  分钟 15分钟内的负载，顾名思义 都是平均值。如果1分钟比较大，但是5、15分钟内都很正常，那么其实可以不用管很担心。</p>
<ul>
<li>负载多少是正常<br>业界觉得单核负责在0.7是正常的， 那么对于笔者4核系统的负载多少合适？  答： 0.7 * 4 = 2.8 只要小于2.8 那么系统就嗖嗖的(当然其他指标正常的情况下)</li>
</ul>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://scoutapp.com/blog/understanding-load-averages" target="_blank" rel="noopener">Understanding Linux CPU Load - when should you be worried?</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://bailinqiang.github.io/2019/03/18/classCastExceptionInGeneric/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="白林强">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="A simple man">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/18/classCastExceptionInGeneric/" itemprop="url">泛型集合获取值时报强转错误</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-18T13:50:20+08:00">
                2019-03-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/泛型/" itemprop="url" rel="index">
                    <span itemprop="name">泛型</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><ul>
<li>简单代码如下<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException </span>&#123;</span><br><span class="line">    List&lt;String&gt; aa = getNames();</span><br><span class="line">    System.out.println(aa);</span><br><span class="line">    <span class="keyword">for</span> (String s : aa) &#123;</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 先不管getNames的 具体实现，可以当成是rpc调用返回结果</span></span><br><span class="line"><span class="comment">// 或者 List&lt;String&gt; 作为rpc调用的参数。无需关心对方是如何设置这个值的</span></span><br></pre></td></tr></table></figure></li>
<li><p>报错信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">1</span>, <span class="number">2</span>]   <span class="comment">// 这个是第一行打印  可以正确的展示出来，并行显示的类型不是String</span></span><br><span class="line">Exception in thread <span class="string">"main"</span> java.lang.ClassCastException: java.lang.Integer cannot be cast to java.lang.String</span><br><span class="line">	at com.moon.switchExplore.ListGenericForBlog.main(ListGenericForBlog.java:<span class="number">20</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>那么问题来了 1、为啥 List&lt;String> 可以存放 Integer 呢  2、List&lt;String> 是如何 add(Integer) 的呢 3、强转发生在什么时候?</p>
</li>
</ul>
<h3 id="接下来一个一个来探索"><a href="#接下来一个一个来探索" class="headerlink" title="接下来一个一个来探索"></a>接下来一个一个来探索</h3><ul>
<li>泛型的作用范围， 一句话 泛型只在编译阶段有效。在运行期会被擦除  那么就可以解释 List&lt;String> 存放Integer的值了，因为只在编译阶段有效。只要通过编译即可。或者骗一骗编译器。接下来是第二个问题 List&lt;String> 怎么add Integer</li>
<li>骗过泛型</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; aa = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">aa.add(<span class="number">1</span>);  <span class="comment">// 这么写 编辑器是会报错的，并行编译阶段会报错 javac时  会报参数不匹配</span></span><br><span class="line"><span class="comment">// 那怎么绕过检查呢  其实就是反射调用  例子</span></span><br><span class="line"></span><br><span class="line">Method method = aa.getClass().getDeclaredMethod(<span class="string">"add"</span>, Object.class);</span><br><span class="line">method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">method.invoke(aa, <span class="number">1</span>);</span><br><span class="line">method.invoke(aa, <span class="number">2</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 这里有一点值得注意下  getDeclaredMethod 的时候 第二个参数要填，必须填Object.class 这是为什么呢 ？ 我们看下 字节码中 List.add方法</span></span><br><span class="line"><span class="comment">* 可以找到下面这句  能够直观的看出来 在运行期  add 方法接受的参数是 Object 所以  反射调用的必须是Object.class</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">InterfaceMethodref #34.#35        // java/util/List.add:(Ljava/lang/Object;)Z</span><br></pre></td></tr></table></figure>
<ul>
<li>强转什么时候发生<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">33: checkcast     #8                  // class java/lang/String</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>查看字节码发现 checkcast这个指令 这个指令去执行类型转换，结果Integer抓换String  不符合jvm规范 所以报错了  </p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li>查看字节码  javap -v (javac 编译后的 class 文件)</li>
<li><a href="http://mbravenboer.blogspot.com/2008/12/why-jvm-spec-defines-checkcast-for.html" target="_blank" rel="noopener">jvm 关于checkcast指令的规定</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://bailinqiang.github.io/2019/03/04/hello/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="白林强">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="A simple man">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/04/hello/" itemprop="url">服务端返回的对象中 双引号被转义成 & quot; 的解决办法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-04T14:31:02+08:00">
                2019-03-04
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web前端/" itemprop="url" rel="index">
                    <span itemprop="name">web前端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>在使用springmvc的时候  用@ResponseBody注解 直接返回对象，但是用ajax查询返回的结果中 引号都被转义了，可以确实是springmvc的处理，在返回的过程中给转义了。那么当时想到的解决办法：</p>
<ul>
<li>端上进行替换、网上有很多的解决办法是这样的，注意一点，js中要用正在表达式才能全部替换掉，replease只能替换第一个匹配到的</li>
<li>服务端返回成JSON String  也就是 先将返回去的对象序列化成jsonstr返回，这样前端接收到的是可以正常解析的 </li>
</ul>
<h3 id="最终解决办法"><a href="#最终解决办法" class="headerlink" title="最终解决办法"></a>最终解决办法</h3><ul>
<li>第一种方案 被排除了，因为在客户端发起的ajax调用，当时没有封装一个统一的出口，所以修改的地方会很多，这个大家在写前端项目的时候可以注意下，封装一个 方法，来统一处理ajax调用 比如 promise(url, data, successFun, failFun) 这种统一方法。</li>
<li>第二种方案，1、简单一点 处理每个方法的返回值，但是这种办法很浪费时间，也不是咱程序员应该处理的，既然是springmvc项目，那么 对springmvc了解一些的同学应该知道，springmvc有统一的对返回值处理的地方，那既然这样的话，我首先去排查一下是哪个 HandlerMethodReturnValueHandler对 引号等进行的转义，<br>2、自己实现一个ReturnValueHandler去将返回对象转换成 JSONstr。<h4 id="找到转义的那个HandlerMethodReturnValueHandler"><a href="#找到转义的那个HandlerMethodReturnValueHandler" class="headerlink" title="找到转义的那个HandlerMethodReturnValueHandler"></a>找到转义的那个HandlerMethodReturnValueHandler</h4></li>
<li>这个应该是比较简单的，我们可以从applicationContext中getBean(class)来获取到具体的values具体代码如下<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RequestMappingHandlerAdapter handlerAdapter = applicationContext.getBean(RequestMappingHandlerAdapter.class);</span><br><span class="line">List&lt;HandlerMethodReturnValueHandler&gt; handlers = <span class="keyword">new</span> ArrayList&lt;HandlerMethodReturnValueHandler&gt;();</span><br><span class="line">List&lt;HandlerMethodReturnValueHandler&gt; returnValueHandlers = handlerAdapter.getReturnValueHandlers();</span><br></pre></td></tr></table></figure>
获取到的大概有一下几个:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ReturnValueHandler  -- 自定义的</span><br><span class="line">ModelAndViewMethodReturnValueHandler</span><br><span class="line">ModelMethodProcessor</span><br><span class="line">ViewMethodReturnValueHandler</span><br><span class="line">ResponseBodyEmitterReturnValueHandler</span><br><span class="line">StreamingResponseBodyReturnValueHandler</span><br><span class="line">HttpEntityMethodProcessor</span><br><span class="line">HttpHeadersReturnValueHandler</span><br><span class="line">CallableMethodReturnValueHandler</span><br><span class="line">DeferredResultMethodReturnValueHandler</span><br><span class="line">AsyncTaskMethodReturnValueHandler</span><br><span class="line">ModelAttributeMethodProcessor</span><br><span class="line">XssRequestResponseBodyMethodProcessor</span><br><span class="line">ViewNameMethodReturnValueHandler</span><br><span class="line">MapMethodProcessor</span><br><span class="line">ModelAttributeMethodProcessor</span><br></pre></td></tr></table></figure>
<ul>
<li>看下springmvc是如何定位具体使用哪个returnHandler的  代码如下：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HandlerMethodReturnValueHandlerComposite</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleReturnValue</span><span class="params">(Object returnValue, MethodParameter returnType,</span></span></span><br><span class="line"><span class="function"><span class="params">			ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    HandlerMethodReturnValueHandler handler = selectHandler(returnValue, returnType);</span><br><span class="line">    <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown return value type: "</span> + returnType.getParameterType().getName());</span><br><span class="line">    &#125;</span><br><span class="line">    handler.handleReturnValue(returnValue, returnType, mavContainer, webRequest);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 核心在 selectHandler  方法中</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> HandlerMethodReturnValueHandler <span class="title">selectHandler</span><span class="params">(Object value, MethodParameter returnType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> isAsyncValue = isAsyncReturnValue(value, returnType);</span><br><span class="line">    <span class="keyword">for</span> (HandlerMethodReturnValueHandler handler : <span class="keyword">this</span>.returnValueHandlers) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isAsyncValue &amp;&amp; !(handler <span class="keyword">instanceof</span> AsyncHandlerMethodReturnValueHandler)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (handler.supportsReturnType(returnType)) &#123;</span><br><span class="line">            <span class="keyword">return</span> handler;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** 可以看出根据 supportReturnType来决定使用哪个handler的，那么我们可以在自定义的returnHandler中 </span></span><br><span class="line"><span class="comment">    重写supportReturnType方法，来支持我们需要处理的那些方法，例如 含有<span class="doctag">@ResponseBody</span>的方法 笔者代码如下：</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsReturnType</span><span class="params">(MethodParameter returnType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> returnType.getMethodAnnotation(ResponseBody.class) != <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 因为笔者项目全部都是 异步调用返回对象而非 ModelAndView 或者View，所以这么写。</span></span><br></pre></td></tr></table></figure></li>
<li>确定handler后 接下来就简单了，只需要在handlerReturnValue中，将Object对象 转换成JSONStr  然后 response.write出去即可 ，笔者代码如下<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleReturnValue</span><span class="params">(Object o, MethodParameter methodParameter, ModelAndViewContainer mavContainer, NativeWebRequest nativeWebRequest)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    HttpServletResponse response = nativeWebRequest.getNativeResponse(HttpServletResponse.class);</span><br><span class="line">    String result = JSON.toJSONString(o);</span><br><span class="line">    mavContainer.setRequestHandled(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (o <span class="keyword">instanceof</span> OpenWorkbenchResult || o <span class="keyword">instanceof</span> ApiResult) &#123;</span><br><span class="line">        result = result.replace(<span class="string">"\t"</span>, <span class="string">""</span>);</span><br><span class="line">        result = result.replace(<span class="string">"\n"</span>, <span class="string">""</span>);</span><br><span class="line">        result = result.replace(<span class="string">"\r"</span>, <span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    response.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">    response.setHeader(<span class="string">"Pragma"</span>, <span class="string">"No-cache"</span>);</span><br><span class="line">    response.setHeader(<span class="string">"Cache-Control"</span>, <span class="string">"no-cache"</span>);</span><br><span class="line">    response.setDateHeader(<span class="string">"Expires"</span>, <span class="number">0</span>);</span><br><span class="line">    response.getWriter().write(result);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment">    if 条件里的 大家尽可以不管，这个是因为笔者项目中  前端json解析服务端返回字段，遇到非法json字符报错，</span></span><br><span class="line"><span class="comment">    所以在这里统一做了处理，如果大家返回json中都是标准的，那么这一步可以不做。</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          
    <div class="comments" id="comments">
      <div id="SOHUCS"></div>
    </div>

  

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/touxiang.jpg" alt="白林强">
            
              <p class="site-author-name" itemprop="name">白林强</p>
              <p class="site-description motion-element" itemprop="description">a simple man records a little simple things</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">白林强</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  














  





  

  

  

  
  

  

  

  

</body>
</html>
